Ext.define("Ext.ux.form.CustomDragSelector",{extend:"Ext.util.Observable",requires:["Ext.util.Region"],alias:"plugin.ux.customdragselector",scrollSpeed:24,lastSelectedIndex:0,isMouseDown:false,selectedItemIndex:0,isScrollerRunning:false,scrollIncreament:0,scrollTopPosition:0,clickedItem:0,shiftIndex:0,breakLoop:false,isControllerRunning:false,tempX:0,tempY:0,isFancy:false,searchResetDelay:1000,nodeHeight:false,rowsPerPage:0,keyCollection:null,currentTime:null,previousTime:null,startIndex:0,lastSearchItem:null,lastKeySelection:null,selectedIndex:0,constructor:function(a){var b=this;
b.addEvents("mousemovestart","mousemoveend");b.callParent([a]);},init:function(a){var b=this;b.view=a;b.selModel=b.view.getSelectionModel();b.view.mon(b.view,"render",b.onRender,b);b.view.mon(b.view,"itemmouseenter",b.onItemMouseEnter,b);b.view.mon(b.view,"itemmouseleave",b.onItemMouseLeave,b);b.view.mon(b.view,"itemmouseup",b.onItemMouseUp,b);
b.view.mon(b.view,"itemmousedown",b.onItemMouseDown,b);b.view.addListener("afterrender",b.registerKeyEvents,b);},onItemMouseOver:function(){},documentMouseUp:function(b){var a=this;a.isMouseDown=false;a.selectedItemIndex=0;a.isScrollerRunning=false;Ext.EventManager.removeListener(document,"mouseup",a.documentMouseUp,a);
Ext.EventManager.removeListener(document,"mousemove",a.documentMouseMove,a);},onItemMouseEnter:function(h,a,f,b,g,c){var d=this;if(d.isControllerRunning==true){d.breakLoop=true;}d.isControllerRunning=false;d.scrollTopPosition=0;if(d.isMouseDown==true){d.doSelectHighlightedItem(h,a,f,b,g);}return false;
},doSelectHighlightedItem:function(h,a,d,b,g){var c=this;var f=true;if(b<c.lastSelectedIndex&&b>=c.clickedItem){f=false;c.selModel.deselect(c.lastSelectedIndex);c.lastSelectedIndex=b;}else{if(b>c.lastSelectedIndex&&b<=c.clickedItem){f=false;c.selModel.deselect(c.lastSelectedIndex);c.lastSelectedIndex=b;
}}if(b!=c.clickedItem&&f){if(c.selModel.isSelected(b)){c.selModel.deselect(b);c.lastSelectedIndex=b;}else{c.selModel.select(b,true);c.lastSelectedIndex=b;}}},onItemMouseLeave:function(g,a,d,b,f,c){this.isControllerRunning=false;return false;},onItemMouseUp:function(h,a,f,b,g,c){var d=this;d.isMouseDown=false;
d.isControllerRunning=false;d.breakLoop=true;d.scrollTopPosition=0;Ext.EventManager.removeListener(document.body,"mousemove",this.getMouseXY,d);if(g.hasModifier()){if(g.ctrlKey){d.doCTRLSelection(b);}else{if(g.shiftKey){d.doSHIFTSelection(b);}}}},doCTRLSelection:function(a){var b=this;if(b.selModel.isSelected(a)){b.selModel.deselect(a);
}else{b.selModel.select(a,true);}},doSHIFTSelection:function(a){var c=this;c.selModel.deselectAll();if(a>c.shiftIndex){for(var b=c.shiftIndex;b<=a;b++){c.selModel.select(b,true);}}else{for(var b=a;b<=c.shiftIndex;b++){c.selModel.select(b,true);}}},onItemMouseDown:function(h,a,f,b,g,c){var d=this;d.selModel.suspendEvents(false);
if(!g.hasModifier()){d.shiftIndex=b;d.deselectAllItems();d.selModel.select(b,true);d.isMouseDown=true;}d.selectedIndex=b;d.scrollTopPosition=0;d.isControllerRunning=false;d.lastSelectedIndex=b;d.clickedItem=b;d.breakLoop=false;Ext.getBody().addCls("textunselectable");d.view.clearHighlight();Ext.EventManager.addListener(document,"mouseup",this.getMouseUP,d);
Ext.EventManager.addListener(document.body,"mousemove",this.getMouseXY,d);},getMouseUP:function(){var a=this;a.isMouseDown=false;a.isControllerRunning=false;a.breakLoop=true;a.scrollTopPosition=0;a.selModel.resumeEvents();a.selModel.fireEvent("selectionchange",a.selModel,a.selModel.getSelection());a.view.removeManagedListener(a.view.getTargetEl(),"click",a.view.handleEvent,a.view);
Ext.EventManager.removeListener(document.body,"mousemove",this.getMouseXY,a);Ext.EventManager.removeListener(document,"mouseup",this.getMouseUP,a);},processListElements:function(){var b=this;var a=b.clickedItem;while(a<=b.lastSelectedIndex){b.selModel.select(a,true);a++;}},documentMouseMove:function(f){var b=this;
var c=f.getPageX();var a=f.getPageY();var d=this.view.getRegion();if(b.isScrollerRunning){return;}if(a>=d.bottom+5){b.isScrollerRunning=true;b.scrollOnMouseMove("bottom");}if(a<=d.top-5){b.isScrollerRunning=true;b.scrollOnMouseMove("top");}},getNodeHeight:function(a){var b=this;return(Ext.fly(b.view.getNode(a)).getHeight()-5);
},getMouseXY:function(g){var d=this;g.preventDefault();var f=g.getTarget();d.tempX=g.getPageX();d.tempY=g.getPageY();if(d.isControllerRunning==true){return;}var a=d.view.getSelectionModel();if(d.tempX<0){d.tempX=0;}if(d.tempY<0){d.tempY=0;}if(d.tempY>=this.view.listEl.getRegion().bottom+5){d.breakLoop=false;
d.isControllerRunning=true;d.isScrollingBottom=true;d.scrollTopPosition=0;if(this.isFancy){var h=$("#"+this.view.getId()+"-outerEl");var c=h.jScrollPane();var b=c.data("jsp");d.smoothFancyScroll(g,"bottom",b);}else{d.scrollOnMouseMove(g,"bottom");}}if(d.tempY<=this.view.listEl.getRegion().top-5){d.breakLoop=false;
d.isScrollingBottom=false;d.isControllerRunning=true;d.scrollTopPosition=0;if(this.isFancy){var h=$("#"+this.view.getId()+"-outerEl");var c=h.jScrollPane();var b=c.data("jsp");d.lastSelectedIndex=d.lastSelectedIndex+1;d.smoothFancyScroll(g,"top",b);}else{d.lastSelectedIndex=d.lastSelectedIndex+1;d.scrollOnMouseMove(g,"top");
}}return true;},smoothFancyScroll:function(g,i,j){var h=this;if(i=="bottom"){if(h.breakLoop){h.scrollTopPosition=0;return;}if(h.lastSelectedIndex>h.view.getStore().getCount()-1){return;}var a=Ext.fly(h.view.getNode(h.lastSelectedIndex)).getHeight();if(h.scrollTopPosition==0){var c=$("#"+h.view.getId()+"-outerEl").find(".jspPane");
var d=Ext.get(h.view.getId()+"-outerEl").select(".jspPane");var f=d.first().getStyle("top",true);f=f.substring(0,f.indexOf("px"));f=Ext.String.trim(f);f=parseInt(f);var b=(f<0)?f*-1:f;h.scrollTopPosition=b;}h.scrollTopPosition=h.scrollTopPosition+a;$("#"+h.view.getId()+"-outerEl").animate({scrollTop:h.scrollTopPosition},h.scrollSpeed,function(){if(h.breakLoop){h.scrollTopPosition=0;
return;}h.lastSelectedIndex++;if(h.lastSelectedIndex>=h.view.getStore().getCount()){return;}if(h.lastSelectedIndex!=h.clickedItem){if(h.selModel.isSelected(h.lastSelectedIndex)){h.selModel.deselect(h.lastSelectedIndex);}else{h.selModel.select(h.lastSelectedIndex,true);}}j.scrollToY(h.scrollTopPosition);
h.smoothFancyScroll(g,"bottom",j);});}else{if(h.breakLoop){h.scrollTopPosition=0;return;}if(h.lastSelectedIndex<0){return;}var a=Ext.fly(h.view.getNode(h.lastSelectedIndex)).getHeight();if(h.scrollTopPosition==0){var c=$("#"+h.view.getId()+"-outerEl").find(".jspPane");var d=Ext.get(h.view.getId()+"-outerEl").select(".jspPane");
var f=d.first().getStyle("top",true);f=f.substring(0,f.indexOf("px"));f=Ext.String.trim(f);f=parseInt(f);var b=(f<0)?f*-1:f;h.scrollTopPosition=b;}h.scrollTopPosition=h.scrollTopPosition-a;$("#"+h.view.getId()+"-outerEl").animate({scrollTop:h.scrollTopPosition},h.scrollSpeed,function(){if(h.breakLoop){h.scrollTopPosition=0;
return;}h.lastSelectedIndex--;if(h.lastSelectedIndex<0){return;}if(h.lastSelectedIndex!=h.clickedItem){if(h.selModel.isSelected(h.lastSelectedIndex)){h.selModel.deselect(h.lastSelectedIndex);}else{h.selModel.select(h.lastSelectedIndex,true);}}j.scrollToY(h.scrollTopPosition);h.smoothFancyScroll(g,"top",j);
});}},scrollOnMouseMove:function(h,c){var f=this;if(c=="bottom"){if(f.breakLoop){f.scrollTopPosition=0;return;}if(f.lastSelectedIndex>f.view.getStore().getCount()-1){return;}if(f.scrollTopPosition==0){var d=parseInt(f.view.listEl.getScroll().top);var b=(d<0)?d*-1:d;f.scrollTopPosition=b;delete d;delete b;
}if(Ext.isIE){f.scrollTopPosition=f.scrollTopPosition+f.getOffsetY(f.view,f.lastSelectedIndex);}else{var g=Ext.fly(f.view.getNode(f.lastSelectedIndex)).getHeight();f.scrollTopPosition=f.scrollTopPosition+g;}$("#"+f.view.getId()+"-listEl").animate({scrollLeft:0},6,function(){if(f.breakLoop){f.scrollTopPosition=0;
return;}f.lastSelectedIndex++;if(f.lastSelectedIndex>=f.view.getStore().getCount()){return;}if(f.lastSelectedIndex!=f.clickedItem){if(f.selModel.isSelected(f.lastSelectedIndex)){f.selModel.deselect(f.lastSelectedIndex);}else{f.selModel.select(f.lastSelectedIndex,true);}}f.view.getTargetEl().scrollTo("top",f.scrollTopPosition);
f.scrollOnMouseMove(h,"bottom");});}else{if(f.breakLoop){f.scrollTopPosition=0;return;}if(f.lastSelectedIndex<0){return;}if(f.scrollTopPosition==0){var d=parseInt(f.view.getTargetEl().getScroll().top);var b=(d<0)?d*-1:d;f.scrollTopPosition=b;delete d;delete b;}if(Ext.isIE){var a=parseInt(f.getOffsetY(f.view,f.lastSelectedIndex));
a=(a<0)?a*-1:a;if(a>0){f.scrollTopPosition=f.scrollTopPosition-a;f.scrollTopPosition=f.scrollTopPosition;}}else{var g=Ext.fly(f.view.getNode(f.lastSelectedIndex)).getHeight();f.scrollTopPosition=f.scrollTopPosition-g;}$("#"+f.view.getId()+"-listEl").animate({scrollLeft:0},6,function(){if(f.breakLoop){f.scrollTopPosition=0;
return;}f.lastSelectedIndex--;if(f.lastSelectedIndex<0){return;}if(f.lastSelectedIndex!=f.clickedItem){if(f.selModel.isSelected(f.lastSelectedIndex)){f.selModel.deselect(f.lastSelectedIndex);}else{f.selModel.select(f.lastSelectedIndex,true);}}f.view.getTargetEl().scrollTo("top",f.scrollTopPosition);f.scrollOnMouseMove(h,"top");
});}},getScrollPosition:function(b,j){b=Ext.getDom(b)||Ext.getBody().dom;var c=j.listEl.dom,f=j.listEl.getOffsetsTo(b),e=f[0]+b.scrollLeft,i=f[1]+b.scrollTop,a=i+c.offsetHeight,k=e+c.offsetWidth,n=b.clientHeight,m=parseInt(b.scrollTop,10),d=parseInt(b.scrollLeft,10),g=m+n,l=d+b.clientWidth,h;if(c.offsetHeight>n||i<m){h=i;
}else{if(a>g){h=a-n;}}return h;},getOffsetY:function(c,h){var f=c.getNode(h),e=c.el,a=0,b=0,g=c.listEl.getRegion(),d;g.bottom=g.top+e.dom.clientHeight;g.right=g.left+e.dom.clientWidth;if(f){d=Ext.fly(f).getRegion();if(d.top<g.top){a=d.top-g.top;}else{if(d.bottom>g.bottom){a=d.bottom-g.bottom;}}}return a;
},deselectAllItems:function(){this.selModel.deselectAll();},onRender:function(){this.scrollIncreament=0;this.lastSelectedIndex=0;this.keyCollection="";},registerKeyEvents:function(){var a=this;Ext.EventManager.addListener(a.view.id+"-inputEl","keypress",this.handleKeyPress,a);Ext.EventManager.addListener(a.view.id+"-inputEl","keydown",this.handleKeyDown,a);
Ext.EventManager.addListener(a.view.id+"-listEl","click",this.handleContainerClick,a);},handleKeyDown:function(d,a){var b=this;var c=d.getKey();if(c==Ext.EventObject.UP){b.up();}else{if(c==Ext.EventObject.DOWN){b.down();}else{if(c==Ext.EventObject.HOME){b.home();}else{if(c==Ext.EventObject.END){b.end();
}else{if(c==Ext.EventObject.PAGE_UP){b.selectPrevPage();}else{if(c==Ext.EventObject.PAGE_DOWN){b.selectNextPage();}}}}}}},selectPrevPage:function(){if(!this.nodeHeight){return;}var a=Math.max(this.selectedIndex-this.rowsPerPage,0);this.highlightAt(a);Ext.get(this.view.id+"-inputEl").focus(true);this.selectedIndex=a;
},selectNextPage:function(){if(!this.nodeHeight){return;}var a=Math.min(this.selectedIndex+this.rowsPerPage,this.view.store.getCount()-1);this.highlightAt(a);Ext.get(this.view.id+"-inputEl").focus(true);this.selectedIndex=a;},calcRowsPerPage:function(){var a=this;if(a.view.store.getCount()){a.nodeHeight=Ext.fly(a.view.getNode(0)).getHeight();
a.rowsPerPage=Math.round(a.view.getHeight()/a.nodeHeight);a.rowsPerPage=a.rowsPerPage-1;}else{a.nodeHeight=false;}},up:function(){var e=this,b=e.view,d=b.all,f=b.highlightedItem,c=f?b.indexOf(f):-1,a=c>0?c-1:d.getCount()-1;if((a==d.getCount()-1)&&e.selectedIndex!=0){a=e.selectedIndex-1;}e.highlightAt(a);
Ext.get(e.view.id+"-inputEl").focus(true);e.selectedIndex=a;},down:function(){var e=this,b=e.view,d=b.all,f=b.highlightedItem,c=f?b.indexOf(f):-1,a=c<d.getCount()-1?c+1:0;if(a==0&&e.selectedIndex!=0){a=e.selectedIndex+1;}e.highlightAt(a);Ext.get(e.view.id+"-inputEl").focus(true);e.selectedIndex=a;},home:function(){this.highlightAt(0);
this.selectedIndex=0;},end:function(){var a=this;a.highlightAt(a.view.all.getCount()-1);a.selectedIndex=a.view.all.getCount()-1;},highlightAt:function(c){var b=this.view,d=b.all.item(c);if(d){d=d.dom;b.highlightItem(d);if(this.isFancy){var e=this.getOffsetY(b,c);var f=$("#"+this.view.getId()+"-outerEl");
var a=f.jScrollPane();api=a.data("jsp");api.scrollToY(e);}else{b.getTargetEl().scrollChildIntoView(d,false);}}},handleContainerClick:function(){var a=this;Ext.get(a.view.id+"-inputEl").focus(true);},handleKeyPress:function(f,j){var h=this;f.preventDefault();var g=f.getTarget();var i=f.getKey();if((f.hasModifier()&&!f.shiftKey)||f.isNavKeyPress()||f.isSpecialKey()){return;
}h.currentTime=new Date().getTime();if(h.previousTime==null||h.previousTime==undefined||h.previousTime.length==0){h.previousTime=new Date().getTime();}if(((h.currentTime-h.previousTime)>h.searchResetDelay)&i!=h.lastKeySelection){h.keyCollection="";h.previousTime=h.currentTime;}if(i!=h.lastKeySelection){h.keyCollection=h.keyCollection+String.fromCharCode(i);
}h.lastKeySelection=i;h.keyCollection=h.keyCollection.toLowerCase();if(h.lastSearchItem==h.keyCollection){h.startIndex++;}else{h.startIndex=0;}var c=h.view.getStore().find(h.view.displayField,h.keyCollection,h.startIndex);h.lastSearchItem=h.keyCollection;if(c>=0){h.startIndex=c;h.selectedIndex=h.startIndex;
h.view.highlightItem(h.view.getNode(c));if(h.isFancy){var d=h.getOffsetY(h.view,c);var a=$("#"+this.view.getId()+"-outerEl");var b=a.jScrollPane();api=b.data("jsp");api.scrollToY(d);}else{h.view.getTargetEl().scrollChildIntoView(h.view.getNode(c),false);}h.view.highlightItem(h.view.getNode(c));}else{h.startIndex=0;
h.selectedIndex=0;}return false;}});