Ext.define("Ext.ux.form.MultiSelect",{extend:"Ext.form.FieldContainer",mixins:{bindable:"Ext.util.Bindable",field:"Ext.form.field.Field"},alternateClassName:"Ext.ux.Multiselect",alias:["widget.multiselectfield","widget.multiselect"],requires:["Ext.panel.Panel","Ext.view.BoundList","Ext.layout.container.Fit"],uses:["Ext.view.DragZone","Ext.view.DropZone"],layout:"fit",ddReorder:false,appendOnly:false,displayField:"text",allowBlank:true,minSelections:0,maxSelections:Number.MAX_VALUE,blankText:"This field is required",minSelectionsText:"Minimum {0} item(s) required",maxSelectionsText:"Minimum {0} item(s) required",delimiter:",",ignoreSelectChange:0,initComponent:function(){var a=this;
a.bindStore(a.store,true);if(a.store.autoCreated){a.valueField=a.displayField="field1";if(!a.store.expanded){a.displayField="field2";}}if(!Ext.isDefined(a.valueField)){a.valueField=a.displayField;}a.items=a.setupItems();a.callParent();a.initField();a.addEvents("drop");},getScrollMultiselect:function(b){isScrollLoaded=false;
getParentHeight=Ext.get(b.id).getHeight();getParentWidth=Ext.get(b.id).getWidth();fieldID=Ext.getCmp(b.id).getComponent(0).getComponent(0).id;Ext.get(b.id).select(".x-boundlist-outer-ct").setHeight(getParentHeight);$("#"+fieldID+" .x-boundlist-outer-ct").css({"width":getParentWidth+"px","overflow":"hidden"});
$("#"+fieldID+" .x-boundlist-list-ct").css({"height":"auto","overflow":"hidden"});var c=$("#"+fieldID+" .x-boundlist-outer-ct");try{if(!isScrollLoaded){if(c!=null&&c!="undefined"){Ext.defer(function(){this.elt=c.jScrollPane();},100);this.apii=c.data("jsp");this.apii.setRecreateFlag(true);}isScrollLoaded=true;
}}catch(a){}},setupItems:function(){var a=this;a.boundList=Ext.create("Ext.view.BoundList",Ext.apply({deferInitialRefresh:false,border:1,multiSelect:true,store:a.store,displayField:a.displayField,disabled:a.disabled,onItemMouseEnter:function(b,d,c,f){return true;},onItemMouseLeave:function(b,d,c,f){return true;
},renderTpl:['<input id="{id}-inputEl" type="text" role="{role}" {inputAttrTpl} class="x-form-field x-form-text x-form-focus x-field-form-focus x-field-default-form-focus" style="position:absolute;left:-999px;opacity:0;letter-spacing: normal;word-spacing: normal;text-transform: none;text-indent: 0px;text-shadow: none;display: inline-block;text-align: start;height:0px" autocomplete="off"','<tpl if="value"> value="{[Ext.util.Format.htmlEncode(values.value)]}"</tpl>','<tpl if="name"> name="{name}"</tpl>','<tpl if="placeholder"> placeholder="{placeholder}"</tpl>','<tpl if="size"> size="{size}"</tpl>','<tpl if="maxLength !== undefined"> maxlength="{maxLength}"</tpl>','<tpl if="readOnly"> readonly="readonly"</tpl>','<tpl if="disabled"> disabled="disabled"</tpl>','<tpl if="tabIdx"> tabIndex="{tabIdx}"</tpl>','<tpl if="fieldStyle"> style="{fieldStyle}"</tpl>',"/>",'<div id="{id}-listEl" class="{baseCls}-list-ct" style="overflow:auto"></div>',"{%","var me=values.$comp, pagingToolbar=me.pagingToolbar;","if (pagingToolbar) {","pagingToolbar.ownerLayout = me.componentLayout;","Ext.DomHelper.generateMarkup(pagingToolbar.getRenderTree(), out);","}","%}",{disableFormats:true}],plugins:[Ext.create("Ext.ux.form.CustomDragSelector",{})]},a.listConfig));
a.boundList.getSelectionModel().on("selectionchange",a.onSelectChange,a);return{border:true,layout:"fit",title:a.title,tbar:a.tbar,items:a.boundList};},onSelectChange:function(a,b){if(!this.ignoreSelectChange){this.setValue(b);}},getSelected:function(){return this.boundList.getSelectionModel().getSelection();
},isEqual:function(e,d){var b=Ext.Array.from,c=0,a;e=b(e);d=b(d);a=e.length;if(a!==d.length){return false;}for(;c<a;c++){if(d[c]!==e[c]){return false;}}return true;},afterRender:function(){var a=this;a.callParent();if(a.selectOnRender){++a.ignoreSelectChange;a.boundList.getSelectionModel().select(a.getRecordsForValue(a.value));
--a.ignoreSelectChange;delete a.toSelect;}if(a.ddReorder&&!a.dragGroup&&!a.dropGroup){a.dragGroup=a.dropGroup="MultiselectDD-"+Ext.id();}if(a.draggable||a.dragGroup){a.dragZone=Ext.create("Ext.view.DragZone",{view:a.boundList,ddGroup:a.dragGroup,onDrag:function(b){a.dragZone.hideProxy();},dragText:"{0} Item{1}"});
}if(a.droppable||a.dropGroup){a.dropZone=Ext.create("Ext.view.DropZone",{view:a.boundList,ddGroup:a.dropGroup,handleNodeDrop:function(h,g,b){var c=this.view,e=c.getStore(),d=h.records,f;if(c.id!=h.view.id){h.view.store.remove(d);f=e.indexOf(g);if(b==="after"){f++;}e.insert(f,d);c.getSelectionModel().select(d);
a.fireEvent("drop",a,d);}}});}},isValid:function(){var b=this,a=b.disabled,c=b.forceValidation||!a;return c?b.validateValue(b.value):a;},validateValue:function(b){var a=this,d=a.getErrors(b),c=Ext.isEmpty(d);if(!a.preventMark){if(c){a.clearInvalid();}else{a.markInvalid(d);}}return c;},markInvalid:function(c){var b=this,a=b.getActiveError();
b.setActiveErrors(Ext.Array.from(c));if(a!==b.getActiveError()){b.updateLayout();}},clearInvalid:function(){var b=this,a=b.hasActiveError();b.unsetActiveError();if(a){b.updateLayout();}},getSubmitData:function(){var a=this,b=null,c;if(!a.disabled&&a.submitValue&&!a.isFileUpload()){c=a.getSubmitValue();
if(c!==null){b={};b[a.getName()]=c;}}return b;},getSubmitValue:function(){var b=this,a=b.delimiter,c=b.getValue();return Ext.isString(a)?c.join(a):c;},getValue:function(){return this.value;},getRecordsForValue:function(g){var f=this,a=[],h=f.store.getRange(),l=f.valueField,d=0,k=h.length,b,c,e;for(e=g.length;
d<e;++d){for(c=0;c<k;++c){b=h[c];if(b.get(l)==g[d]){a.push(b);}}}return a;},setupValue:function(g){var b=this.delimiter,d=this.valueField,e=0,c,a,f;if(Ext.isDefined(g)){if(b&&Ext.isString(g)){g=g.split(b);}else{if(!Ext.isArray(g)){g=[g];}}for(a=g.length;e<a;++e){f=g[e];if(f&&f.isModel){g[e]=f.get(d);
}}c=Ext.Array.unique(g);}else{c=[];}return c;},setValue:function(b){var a=this;selModel=a.boundList.getSelectionModel();if((a!=null&&a!="null")&&!Ext.isEmpty(a)&&!Ext.isEmpty(a.store)&&!a.store.getCount()){a.store.on({load:Ext.Function.bind(a.setValue,a,[b]),single:true});return;}b=a.setupValue(b);a.mixins.field.setValue.call(a,b);
if(a.rendered){++a.ignoreSelectChange;selModel.deselectAll();selModel.select(a.getRecordsForValue(b));--a.ignoreSelectChange;}else{a.selectOnRender=true;}},clearValue:function(){this.setValue([]);},onEnable:function(){var a=this.boundList;this.callParent();if(a){a.enable();}},onDisable:function(){var a=this.boundList;
this.callParent();if(a){a.disable();}},getErrors:function(b){var a=this,c=Ext.String.format,e=[],d;b=Ext.Array.from(b||a.getValue());d=b.length;if(!a.allowBlank&&d<1){e.push(a.blankText);}if(d<a.minSelections){e.push(c(a.minSelectionsText,a.minSelections));}if(d>a.maxSelections){e.push(c(a.maxSelectionsText,a.maxSelections));
}return e;},onDestroy:function(){var a=this;a.bindStore(null);Ext.destroy(a.dragZone,a.dropZone);a.callParent();},onBindStore:function(a){var b=this.boundList;if(b){b.bindStore(a);}}});