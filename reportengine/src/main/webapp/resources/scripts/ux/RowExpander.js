Ext.define("Ext.ux.RowExpander",{extend:"Ext.AbstractPlugin",requires:["Ext.grid.feature.RowBody","Ext.grid.feature.RowWrap"],alias:"plugin.rowexpander",rowBodyTpl:null,expandOnEnter:true,expandOnDblClick:true,selectRowOnExpand:false,rowBodyTrSelector:".x-grid-rowbody-tr",rowBodyHiddenCls:"x-grid-row-body-hidden",rowCollapsedCls:"x-grid-row-collapsed",renderer:function(d,b,a,c,e){if(e===0){b.tdCls="x-grid-td-expander";
}return'<div class="x-grid-row-expander">&#160;</div>';},constructor:function(){this.callParent(arguments);var b=this.getCmp();this.recordsExpanded={};if(!this.rowBodyTpl){Ext.Error.raise("The 'rowBodyTpl' config is required and is not defined.");}var a=Ext.create("Ext.XTemplate",this.rowBodyTpl),c=[{ftype:"rowbody",columnId:this.getHeaderId(),recordsExpanded:this.recordsExpanded,rowBodyHiddenCls:this.rowBodyHiddenCls,rowCollapsedCls:this.rowCollapsedCls,getAdditionalData:this.getRowBodyFeatureData,getRowBodyContents:function(d){return a.applyTemplate(d);
}},{ftype:"rowwrap"}];if(b.features){b.features=c.concat(b.features);}else{b.features=c;}},init:function(a){this.callParent(arguments);this.grid=a;this.addExpander();a.on("render",this.bindView,this,{single:true});a.on("reconfigure",this.onReconfigure,this);},onReconfigure:function(){this.addExpander();
},addExpander:function(){this.grid.headerCt.insert(0,this.getHeaderConfig());},getHeaderId:function(){if(!this.headerId){this.headerId=Ext.id();}return this.headerId;},getRowBodyFeatureData:function(c,a,b,f){var d=Ext.grid.feature.RowBody.prototype.getAdditionalData.apply(this,arguments),e=this.columnId;
d.rowBodyColspan=d.rowBodyColspan-1;d.rowBody=this.getRowBodyContents(c);d.rowCls=this.recordsExpanded[b.internalId]?"":this.rowCollapsedCls;d.rowBodyCls=this.recordsExpanded[b.internalId]?"":this.rowBodyHiddenCls;d[e+"-tdAttr"]=' valign="top" rowspan="2" ';if(f[e+"-tdAttr"]){d[e+"-tdAttr"]+=f[e+"-tdAttr"];
}return d;},bindView:function(){var a=this.getCmp().getView(),b;if(!a.rendered){a.on("render",this.bindView,this,{single:true});}else{b=a.getEl();if(this.expandOnEnter){this.keyNav=Ext.create("Ext.KeyNav",b,{"enter":this.onEnter,scope:this});}if(this.expandOnDblClick){a.on("itemdblclick",this.onDblClick,this);
}this.view=a;}},onEnter:function(h){var b=this.view,g=b.store,j=b.getSelectionModel(),a=j.getSelection(),f=a.length,c=0,d;for(;c<f;c++){d=g.indexOf(a[c]);this.toggleRow(d);}},toggleRow:function(f){var b=this.view,e=b.getNode(f),g=Ext.get(e),c=Ext.get(g).down(this.rowBodyTrSelector),a=b.getRecord(e),d=this.getCmp();
if(g.hasCls(this.rowCollapsedCls)){g.removeCls(this.rowCollapsedCls);c.removeCls(this.rowBodyHiddenCls);this.recordsExpanded[a.internalId]=true;b.refreshSize();b.fireEvent("expandbody",e,a,c.dom);}else{g.addCls(this.rowCollapsedCls);c.addCls(this.rowBodyHiddenCls);this.recordsExpanded[a.internalId]=false;
b.refreshSize();b.fireEvent("collapsebody",e,a,c.dom);}},onDblClick:function(b,a,d,c,f){this.toggleRow(d);},getHeaderConfig:function(){var c=this,b=Ext.Function.bind(c.toggleRow,c),a=c.selectRowOnExpand;return{id:this.getHeaderId(),width:24,sortable:false,resizable:false,draggable:false,hideable:false,menuDisabled:true,cls:Ext.baseCSSPrefix+"grid-header-special",renderer:function(e,d){d.tdCls=Ext.baseCSSPrefix+"grid-cell-special";
return'<div class="'+Ext.baseCSSPrefix+'grid-row-expander">&#160;</div>';},processEvent:function(i,f,d,g,h,j){if(i=="mousedown"&&j.getTarget(".x-grid-row-expander")){var k=j.getTarget(".x-grid-row");b(k);return a;}}};}});